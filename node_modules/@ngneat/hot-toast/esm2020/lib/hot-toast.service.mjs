import { isPlatformServer } from '@angular/common';
import { Inject, Injectable, Optional, PLATFORM_ID } from '@angular/core';
import { isComponent, isTemplateRef } from '@ngneat/overview';
import { defer } from 'rxjs';
import { tap } from 'rxjs/operators';
import { HotToastContainerComponent } from './components/hot-toast-container/hot-toast-container.component';
import { HOT_TOAST_DEFAULT_TIMEOUTS } from './constants';
import { HotToastRef } from './hot-toast-ref';
import { resolveValueOrFunction, ToastConfig, ToastPersistConfig, } from './hot-toast.model';
import * as i0 from "@angular/core";
import * as i1 from "@ngneat/overview";
import * as i2 from "./hot-toast.model";
export class HotToastService {
    constructor(_viewService, platformId, config) {
        this._viewService = _viewService;
        this.platformId = platformId;
        this._isInitialized = false;
        this._defaultConfig = new ToastConfig();
        this._defaultPersistConfig = new ToastPersistConfig();
        if (config) {
            this._defaultConfig = {
                ...this._defaultConfig,
                ...config,
            };
        }
    }
    get defaultConfig() {
        return this._defaultConfig;
    }
    set defaultConfig(config) {
        this._defaultConfig = {
            ...this._defaultConfig,
            ...config,
        };
        if (this._componentRef) {
            this._componentRef.setInput('defaultConfig', this._defaultConfig);
        }
    }
    /**
     * Opens up an hot-toast without any pre-configurations
     *
     * @param message The message to show in the hot-toast.
     * @param [options] Additional configuration options for the hot-toast.
     * @returns
     * @memberof HotToastService
     */
    show(message, options) {
        const toast = this.createToast(message || this._defaultConfig.blank.content, 'blank', {
            ...this._defaultConfig,
            ...options,
        });
        return toast;
    }
    /**
     * Opens up an hot-toast with pre-configurations for error state
     *
     * @param message The message to show in the hot-toast.
     * @param [options] Additional configuration options for the hot-toast.
     * @returns
     * @memberof HotToastService
     */
    error(message, options) {
        const toast = this.createToast(message || this._defaultConfig.error.content, 'error', {
            ...this._defaultConfig,
            ...this._defaultConfig?.error,
            ...options,
        });
        return toast;
    }
    /**
     * Opens up an hot-toast with pre-configurations for success state
     *
     * @param message The message to show in the hot-toast.
     * @param [options] Additional configuration options for the hot-toast.
     * @returns
     * @memberof HotToastService
     */
    success(message, options) {
        const toast = this.createToast(message || this._defaultConfig.success.content, 'success', {
            ...this._defaultConfig,
            ...this._defaultConfig?.success,
            ...options,
        });
        return toast;
    }
    /**
     * Opens up an hot-toast with pre-configurations for loading state
     *
     * @param message The message to show in the hot-toast.
     * @param [options] Additional configuration options for the hot-toast.
     * @returns
     * @memberof HotToastService
     */
    loading(message, options) {
        const toast = this.createToast(message || this._defaultConfig.loading.content, 'loading', {
            ...this._defaultConfig,
            ...this._defaultConfig?.loading,
            ...options,
        });
        return toast;
    }
    /**
     * Opens up an hot-toast with pre-configurations for warning state
     *
     * @param message The message to show in the hot-toast.
     * @param [options] Additional configuration options for the hot-toast.
     * @returns
     * @memberof HotToastService
     */
    warning(message, options) {
        const toast = this.createToast(message || this._defaultConfig.warning.content, 'warning', {
            ...this._defaultConfig,
            ...this._defaultConfig?.warning,
            ...options,
        });
        return toast;
    }
    /**
     * Opens up an hot-toast with pre-configurations for info state
     *
     * @param message The message to show in the hot-toast.
     * @param [options] Additional configuration options for the hot-toast.
     * @returns
     * @memberof HotToastService
     * @since 3.3.0
     */
    info(message, options) {
        const toast = this.createToast(message || this._defaultConfig.warning.content, 'info', {
            ...this._defaultConfig,
            ...this._defaultConfig?.warning,
            ...options,
        });
        return toast;
    }
    /**
     *
     *  Opens up an hot-toast with pre-configurations for loading initially and then changes state based on messages
     *
     * @template T Type of observable
     * @param messages Messages for each state i.e. loading, success and error
     * @returns
     * @memberof HotToastService
     */
    observe(messages) {
        return (source) => {
            let toastRef;
            let start = 0;
            const loadingContent = messages.loading ?? this._defaultConfig.loading?.content;
            const successContent = messages.success ?? this._defaultConfig.success?.content;
            const errorContent = messages.error ?? this._defaultConfig.error?.content;
            return defer(() => {
                if (loadingContent) {
                    toastRef = this.createLoadingToast(loadingContent);
                    start = Date.now();
                }
                return source.pipe(tap({
                    ...(successContent && {
                        next: (val) => {
                            toastRef = this.createOrUpdateToast(messages, val, toastRef, 'success', start === 0 ? start : Date.now() - start);
                        },
                    }),
                    ...(errorContent && {
                        error: (e) => {
                            toastRef = this.createOrUpdateToast(messages, e, toastRef, 'error', start === 0 ? start : Date.now() - start);
                        },
                    }),
                }));
            });
        };
    }
    /**
     * Closes the hot-toast
     *
     * @param [id] - ID of the toast
     * @since 3.0.1 - If ID is not provided, all toasts will be closed
     */
    close(id) {
        if (this._componentRef) {
            this._componentRef.ref.instance.closeToast(id);
        }
    }
    /**
     * Used for internal purpose only.
     * Creates a container component and attaches it to document.body.
     */
    init() {
        if (isPlatformServer(this.platformId)) {
            return;
        }
        this._componentRef = this._viewService
            .createComponent(HotToastContainerComponent)
            .setInput('defaultConfig', this._defaultConfig)
            .appendTo(document.body);
    }
    createOrUpdateToast(messages, val, toastRef, type, diff) {
        let content = null;
        let options = {};
        ({ content, options } = this.getContentAndOptions(type, messages[type] || (this._defaultConfig[type] ? this._defaultConfig[type].content : '')));
        content = resolveValueOrFunction(content, val);
        if (toastRef) {
            toastRef.updateMessage(content);
            const updatedOptions = {
                type,
                duration: diff + HOT_TOAST_DEFAULT_TIMEOUTS[type],
                ...options,
                ...(options.duration && { duration: diff + options.duration }),
            };
            toastRef.updateToast(updatedOptions);
        }
        else {
            this.createToast(content, type, options);
        }
        return toastRef;
    }
    createToast(message, type, options, observableMessages) {
        if (!this._isInitialized) {
            this._isInitialized = true;
            this.init();
        }
        const now = Date.now();
        const id = options?.id ?? now.toString();
        if (!this.isDuplicate(id) &&
            (!options.persist?.enabled || (options.persist?.enabled && this.handleStorageValue(id, options)))) {
            const toast = {
                ariaLive: options?.ariaLive ?? 'polite',
                createdAt: now,
                duration: options?.duration ?? HOT_TOAST_DEFAULT_TIMEOUTS[type],
                id,
                message,
                role: options?.role ?? 'status',
                type,
                visible: true,
                observableMessages: observableMessages ?? undefined,
                ...options,
            };
            return new HotToastRef(toast).appendTo(this._componentRef.ref.instance);
        }
    }
    /**
     * Checks whether any toast with same id is present.
     *
     * @private
     * @param id - Toast ID
     */
    isDuplicate(id) {
        return this._componentRef.ref.instance.hasToast(id);
    }
    /**
     * Creates an entry in local or session storage with count ${defaultConfig.persist.count}, if not present.
     * If present in storage, reduces the count
     * and returns the count.
     * Count can not be less than 0.
     */
    handleStorageValue(id, options) {
        let count = 1;
        const persist = { ...this._defaultPersistConfig, ...options.persist };
        const storage = persist.storage === 'local' ? localStorage : sessionStorage;
        const key = persist.key.replace(/\${id}/g, id);
        let item = storage.getItem(key);
        if (item) {
            item = parseInt(item, 10);
            if (item > 0) {
                count = item - 1;
            }
            else {
                count = item;
            }
        }
        else {
            count = persist.count;
        }
        storage.setItem(key, count.toString());
        return count;
    }
    getContentAndOptions(toastType, message) {
        let content;
        let options = {
            ...this._defaultConfig,
            ...this._defaultConfig[toastType],
        };
        // typeof message === 'object' won't work, cz TemplateRef's type is object
        if (typeof message === 'string' || isTemplateRef(message) || isComponent(message)) {
            content = message;
        }
        else {
            let restOptions;
            ({ content, ...restOptions } = message);
            options = { ...options, ...restOptions };
        }
        return { content, options };
    }
    createLoadingToast(messages) {
        let content = null;
        let options = {};
        ({ content, options } = this.getContentAndOptions('loading', messages));
        return this.loading(content, options);
    }
}
HotToastService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.0.1", ngImport: i0, type: HotToastService, deps: [{ token: i1.ViewService }, { token: PLATFORM_ID }, { token: i2.ToastConfig, optional: true }], target: i0.ɵɵFactoryTarget.Injectable });
HotToastService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.0.1", ngImport: i0, type: HotToastService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.0.1", ngImport: i0, type: HotToastService, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }], ctorParameters: function () { return [{ type: i1.ViewService }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [PLATFORM_ID]
                }] }, { type: i2.ToastConfig, decorators: [{
                    type: Optional
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG90LXRvYXN0LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ25lYXQvaG90LXRvYXN0L3NyYy9saWIvaG90LXRvYXN0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDbkQsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMxRSxPQUFPLEVBQW9CLFdBQVcsRUFBRSxhQUFhLEVBQWUsTUFBTSxrQkFBa0IsQ0FBQztBQUM3RixPQUFPLEVBQUUsS0FBSyxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQ3pDLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVyQyxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxnRUFBZ0UsQ0FBQztBQUM1RyxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDekQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzlDLE9BQU8sRUFPTCxzQkFBc0IsRUFFdEIsV0FBVyxFQUVYLGtCQUFrQixHQUluQixNQUFNLG1CQUFtQixDQUFDOzs7O0FBRzNCLE1BQU0sT0FBTyxlQUFlO0lBbUIxQixZQUNVLFlBQXlCLEVBQ0osVUFBa0IsRUFDbkMsTUFBbUI7UUFGdkIsaUJBQVksR0FBWixZQUFZLENBQWE7UUFDSixlQUFVLEdBQVYsVUFBVSxDQUFRO1FBcEJ6QyxtQkFBYyxHQUFHLEtBQUssQ0FBQztRQUd2QixtQkFBYyxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7UUFhbkMsMEJBQXFCLEdBQUcsSUFBSSxrQkFBa0IsRUFBRSxDQUFDO1FBT3ZELElBQUksTUFBTSxFQUFFO1lBQ1YsSUFBSSxDQUFDLGNBQWMsR0FBRztnQkFDcEIsR0FBRyxJ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V0FBbUMsQ0FBQztZQUN4QyxDQUFDLEVBQUUsT0FBTyxFQUFFLEdBQUcsV0FBVyxFQUFFLEdBQUcsT0FBOEUsQ0FBQyxDQUFDO1lBQy9HLE9BQU8sR0FBRyxFQUFFLEdBQUcsT0FBTyxFQUFFLEdBQUcsV0FBVyxFQUFFLENBQUM7U0FDMUM7UUFFRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxDQUFDO0lBQzlCLENBQUM7SUFFTyxrQkFBa0IsQ0FBYyxRQUErQztRQUNyRixJQUFJLE9BQU8sR0FBMEMsSUFBSSxDQUFDO1FBQzFELElBQUksT0FBTyxHQUFxQyxFQUFFLENBQUM7UUFFbkQsQ0FBQyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQWdCLFNBQVMsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBRXZGLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFrQixFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ25ELENBQUM7OzRHQWhXVSxlQUFlLDZDQXFCaEIsV0FBVztnSEFyQlYsZUFBZSxjQURGLE1BQU07MkZBQ25CLGVBQWU7a0JBRDNCLFVBQVU7bUJBQUMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFOzswQkFzQjdCLE1BQU07MkJBQUMsV0FBVzs7MEJBQ2xCLFFBQVEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpc1BsYXRmb3JtU2VydmVyIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgT3B0aW9uYWwsIFBMQVRGT1JNX0lEIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBDb21wUmVmLCBDb250ZW50LCBpc0NvbXBvbmVudCwgaXNUZW1wbGF0ZVJlZiwgVmlld1NlcnZpY2UgfSBmcm9tICdAbmduZWF0L292ZXJ2aWV3JztcbmltcG9ydCB7IGRlZmVyLCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IEhvdFRvYXN0Q29udGFpbmVyQ29tcG9uZW50IH0gZnJvbSAnLi9jb21wb25lbnRzL2hvdC10b2FzdC1jb250YWluZXIvaG90LXRvYXN0LWNvbnRhaW5lci5jb21wb25lbnQnO1xuaW1wb3J0IHsgSE9UX1RPQVNUX0RFRkFVTFRfVElNRU9VVFMgfSBmcm9tICcuL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBIb3RUb2FzdFJlZiB9IGZyb20gJy4vaG90LXRvYXN0LXJlZic7XG5pbXBvcnQge1xuICBDcmVhdGVIb3RUb2FzdFJlZixcbiAgRGVmYXVsdFRvYXN0T3B0aW9ucyxcbiAgSG90VG9hc3RTZXJ2aWNlTWV0aG9kcyxcbiAgT2JzZXJ2YWJsZUxvYWRpbmcsXG4gIE9ic2VydmFibGVNZXNzYWdlcyxcbiAgT2JzZXJ2YWJsZVN1Y2Nlc3NPckVycm9yLFxuICByZXNvbHZlVmFsdWVPckZ1bmN0aW9uLFxuICBUb2FzdCxcbiAgVG9hc3RDb25maWcsXG4gIFRvYXN0T3B0aW9ucyxcbiAgVG9hc3RQZXJzaXN0Q29uZmlnLFxuICBUb2FzdFR5cGUsXG4gIFVwZGF0ZVRvYXN0T3B0aW9ucyxcbiAgVmFsdWVPckZ1bmN0aW9uLFxufSBmcm9tICcuL2hvdC10b2FzdC5tb2RlbCc7XG5cbkBJbmplY3RhYmxlKHsgcHJvdmlkZWRJbjogJ3Jvb3QnIH0pXG5leHBvcnQgY2xhc3MgSG90VG9hc3RTZXJ2aWNlIGltcGxlbWVudHMgSG90VG9hc3RTZXJ2aWNlTWV0aG9kcyB7XG4gIHByaXZhdGUgX2lzSW5pdGlhbGl6ZWQgPSBmYWxzZTtcbiAgcHJpdmF0ZSBfY29tcG9uZW50UmVmOiBDb21wUmVmPEhvdFRvYXN0Q29udGFpbmVyQ29tcG9uZW50PjtcblxuICBwcml2YXRlIF9kZWZhdWx0Q29uZmlnID0gbmV3IFRvYXN0Q29uZmlnKCk7XG4gIGdldCBkZWZhdWx0Q29uZmlnKCkge1xuICAgIHJldHVybiB0aGlzLl9kZWZhdWx0Q29uZmlnO1xuICB9XG4gIHNldCBkZWZhdWx0Q29uZmlnKGNvbmZpZzogVG9hc3RDb25maWcpIHtcbiAgICB0aGlzLl9kZWZhdWx0Q29uZmlnID0ge1xuICAgICAgLi4udGhpcy5fZGVmYXVsdENvbmZpZyxcbiAgICAgIC4uLmNvbmZpZyxcbiAgICB9O1xuICAgIGlmICh0aGlzLl9jb21wb25lbnRSZWYpIHtcbiAgICAgIHRoaXMuX2NvbXBvbmVudFJlZi5zZXRJbnB1dCgnZGVmYXVsdENvbmZpZycsIHRoaXMuX2RlZmF1bHRDb25maWcpO1xuICAgIH1cbiAgfVxuICBwcml2YXRlIF9kZWZhdWx0UGVyc2lzdENvbmZpZyA9IG5ldyBUb2FzdFBlcnNpc3RDb25maWcoKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIF92aWV3U2VydmljZTogVmlld1NlcnZpY2UsXG4gICAgQEluamVjdChQTEFURk9STV9JRCkgcHJpdmF0ZSBwbGF0Zm9ybUlkOiBzdHJpbmcsXG4gICAgQE9wdGlvbmFsKCkgY29uZmlnOiBUb2FzdENvbmZpZ1xuICApIHtcbiAgICBpZiAoY29uZmlnKSB7XG4gICAgICB0aGlzLl9kZWZhdWx0Q29uZmlnID0ge1xuICAgICAgICAuLi50aGlzLl9kZWZhdWx0Q29uZmlnLFxuICAgICAgICAuLi5jb25maWcsXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBPcGVucyB1cCBhbiBob3QtdG9hc3Qgd2l0aG91dCBhbnkgcHJlLWNvbmZpZ3VyYXRpb25zXG4gICAqXG4gICAqIEBwYXJhbSBtZXNzYWdlIFRoZSBtZXNzYWdlIHRvIHNob3cgaW4gdGhlIGhvdC10b2FzdC5cbiAgICogQHBhcmFtIFtvcHRpb25zXSBBZGRpdGlvbmFsIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgdGhlIGhvdC10b2FzdC5cbiAgICogQHJldHVybnNcbiAgICogQG1lbWJlcm9mIEhvdFRvYXN0U2VydmljZVxuICAgKi9cbiAgc2hvdzxEYXRhVHlwZT4obWVzc2FnZT86IENvbnRlbnQsIG9wdGlvbnM/OiBUb2FzdE9wdGlvbnM8RGF0YVR5cGU+KTogQ3JlYXRlSG90VG9hc3RSZWY8RGF0YVR5cGUgfCB1bmtub3duPiB7XG4gICAgY29uc3QgdG9hc3QgPSB0aGlzLmNyZWF0ZVRvYXN0PERhdGFUeXBlPihtZXNzYWdlIHx8IHRoaXMuX2RlZmF1bHRDb25maWcuYmxhbmsuY29udGVudCwgJ2JsYW5rJywge1xuICAgICAgLi4udGhpcy5fZGVmYXVsdENvbmZpZyxcbiAgICAgIC4uLm9wdGlvbnMsXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdG9hc3Q7XG4gIH1cblxuICAvKipcbiAgICogT3BlbnMgdXAgYW4gaG90LXRvYXN0IHdpdGggcHJlLWNvbmZpZ3VyYXRpb25zIGZvciBlcnJvciBzdGF0ZVxuICAgKlxuICAgKiBAcGFyYW0gbWVzc2FnZSBUaGUgbWVzc2FnZSB0byBzaG93IGluIHRoZSBob3QtdG9hc3QuXG4gICAqIEBwYXJhbSBbb3B0aW9uc10gQWRkaXRpb25hbCBjb25maWd1cmF0aW9uIG9wdGlvbnMgZm9yIHRoZSBob3QtdG9hc3QuXG4gICAqIEByZXR1cm5zXG4gICAqIEBtZW1iZXJvZiBIb3RUb2FzdFNlcnZpY2VcbiAgICovXG4gIGVycm9yPERhdGFUeXBlPihtZXNzYWdlPzogQ29udGVudCwgb3B0aW9ucz86IFRvYXN0T3B0aW9uczxEYXRhVHlwZT4pOiBDcmVhdGVIb3RUb2FzdFJlZjxEYXRhVHlwZSB8IHVua25vd24+IHtcbiAgICBjb25zdCB0b2FzdCA9IHRoaXMuY3JlYXRlVG9hc3Q8RGF0YVR5cGU+KG1lc3NhZ2UgfHwgdGhpcy5fZGVmYXVsdENvbmZpZy5lcnJvci5jb250ZW50LCAnZXJyb3InLCB7XG4gICAgICAuLi50aGlzLl9kZWZhdWx0Q29uZmlnLFxuICAgICAgLi4udGhpcy5fZGVmYXVsdENvbmZpZz8uZXJyb3IsXG4gICAgICAuLi5vcHRpb25zLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRvYXN0O1xuICB9XG5cbiAgLyoqXG4gICAqIE9wZW5zIHVwIGFuIGhvdC10b2FzdCB3aXRoIHByZS1jb25maWd1cmF0aW9ucyBmb3Igc3VjY2VzcyBzdGF0ZVxuICAgKlxuICAgKiBAcGFyYW0gbWVzc2FnZSBUaGUgbWVzc2FnZSB0byBzaG93IGluIHRoZSBob3QtdG9hc3QuXG4gICAqIEBwYXJhbSBbb3B0aW9uc10gQWRkaXRpb25hbCBjb25maWd1cmF0aW9uIG9wdGlvbnMgZm9yIHRoZSBob3QtdG9hc3QuXG4gICAqIEByZXR1cm5zXG4gICAqIEBtZW1iZXJvZiBIb3RUb2FzdFNlcnZpY2VcbiAgICovXG4gIHN1Y2Nlc3M8RGF0YVR5cGU+KG1lc3NhZ2U/OiBDb250ZW50LCBvcHRpb25zPzogVG9hc3RPcHRpb25zPERhdGFUeXBlPik6IENyZWF0ZUhvdFRvYXN0UmVmPERhdGFUeXBlIHwgdW5rbm93bj4ge1xuICAgIGNvbnN0IHRvYXN0ID0gdGhpcy5jcmVhdGVUb2FzdDxEYXRhVHlwZT4obWVzc2FnZSB8fCB0aGlzLl9kZWZhdWx0Q29uZmlnLnN1Y2Nlc3MuY29udGVudCwgJ3N1Y2Nlc3MnLCB7XG4gICAgICAuLi50aGlzLl9kZWZhdWx0Q29uZmlnLFxuICAgICAgLi4udGhpcy5fZGVmYXVsdENvbmZpZz8uc3VjY2VzcyxcbiAgICAgIC4uLm9wdGlvbnMsXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdG9hc3Q7XG4gIH1cblxuICAvKipcbiAgICogT3BlbnMgdXAgYW4gaG90LXRvYXN0IHdpdGggcHJlLWNvbmZpZ3VyYXRpb25zIGZvciBsb2FkaW5nIHN0YXRlXG4gICAqXG4gICAqIEBwYXJhbSBtZXNzYWdlIFRoZSBtZXNzYWdlIHRvIHNob3cgaW4gdGhlIGhvdC10b2FzdC5cbiAgICogQHBhcmFtIFtvcHRpb25zXSBBZGRpdGlvbmFsIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgdGhlIGhvdC10b2FzdC5cbiAgICogQHJldHVybnNcbiAgICogQG1lbWJlcm9mIEhvdFRvYXN0U2VydmljZVxuICAgKi9cbiAgbG9hZGluZzxEYXRhVHlwZT4obWVzc2FnZT86IENvbnRlbnQsIG9wdGlvbnM/OiBUb2FzdE9wdGlvbnM8RGF0YVR5cGU+KTogQ3JlYXRlSG90VG9hc3RSZWY8RGF0YVR5cGUgfCB1bmtub3duPiB7XG4gICAgY29uc3QgdG9hc3QgPSB0aGlzLmNyZWF0ZVRvYXN0PERhdGFUeXBlPihtZXNzYWdlIHx8IHRoaXMuX2RlZmF1bHRDb25maWcubG9hZGluZy5jb250ZW50LCAnbG9hZGluZycsIHtcbiAgICAgIC4uLnRoaXMuX2RlZmF1bHRDb25maWcsXG4gICAgICAuLi50aGlzLl9kZWZhdWx0Q29uZmlnPy5sb2FkaW5nLFxuICAgICAgLi4ub3B0aW9ucyxcbiAgICB9KTtcblxuICAgIHJldHVybiB0b2FzdDtcbiAgfVxuXG4gIC8qKlxuICAgKiBPcGVucyB1cCBhbiBob3QtdG9hc3Qgd2l0aCBwcmUtY29uZmlndXJhdGlvbnMgZm9yIHdhcm5pbmcgc3RhdGVcbiAgICpcbiAgICogQHBhcmFtIG1lc3NhZ2UgVGhlIG1lc3NhZ2UgdG8gc2hvdyBpbiB0aGUgaG90LXRvYXN0LlxuICAgKiBAcGFyYW0gW29wdGlvbnNdIEFkZGl0aW9uYWwgY29uZmlndXJhdGlvbiBvcHRpb25zIGZvciB0aGUgaG90LXRvYXN0LlxuICAgKiBAcmV0dXJuc1xuICAgKiBAbWVtYmVyb2YgSG90VG9hc3RTZXJ2aWNlXG4gICAqL1xuICB3YXJuaW5nPERhdGFUeXBlPihtZXNzYWdlPzogQ29udGVudCwgb3B0aW9ucz86IFRvYXN0T3B0aW9uczxEYXRhVHlwZT4pOiBDcmVhdGVIb3RUb2FzdFJlZjxEYXRhVHlwZSB8IHVua25vd24+IHtcbiAgICBjb25zdCB0b2FzdCA9IHRoaXMuY3JlYXRlVG9hc3Q8RGF0YVR5cGU+KG1lc3NhZ2UgfHwgdGhpcy5fZGVmYXVsdENvbmZpZy53YXJuaW5nLmNvbnRlbnQsICd3YXJuaW5nJywge1xuICAgICAgLi4udGhpcy5fZGVmYXVsdENvbmZpZyxcbiAgICAgIC4uLnRoaXMuX2RlZmF1bHRDb25maWc/Lndhcm5pbmcsXG4gICAgICAuLi5vcHRpb25zLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRvYXN0O1xuICB9XG5cbiAgLyoqXG4gICAqIE9wZW5zIHVwIGFuIGhvdC10b2FzdCB3aXRoIHByZS1jb25maWd1cmF0aW9ucyBmb3IgaW5mbyBzdGF0ZVxuICAgKlxuICAgKiBAcGFyYW0gbWVzc2FnZSBUaGUgbWVzc2FnZSB0byBzaG93IGluIHRoZSBob3QtdG9hc3QuXG4gICAqIEBwYXJhbSBbb3B0aW9uc10gQWRkaXRpb25hbCBjb25maWd1cmF0aW9uIG9wdGlvbnMgZm9yIHRoZSBob3QtdG9hc3QuXG4gICAqIEByZXR1cm5zXG4gICAqIEBtZW1iZXJvZiBIb3RUb2FzdFNlcnZpY2VcbiAgICogQHNpbmNlIDMuMy4wXG4gICAqL1xuICBpbmZvPERhdGFUeXBlPihtZXNzYWdlPzogQ29udGVudCwgb3B0aW9ucz86IFRvYXN0T3B0aW9uczxEYXRhVHlwZT4pOiBDcmVhdGVIb3RUb2FzdFJlZjxEYXRhVHlwZSB8IHVua25vd24+IHtcbiAgICBjb25zdCB0b2FzdCA9IHRoaXMuY3JlYXRlVG9hc3Q8RGF0YVR5cGU+KG1lc3NhZ2UgfHwgdGhpcy5fZGVmYXVsdENvbmZpZy53YXJuaW5nLmNvbnRlbnQsICdpbmZvJywge1xuICAgICAgLi4udGhpcy5fZGVmYXVsdENvbmZpZyxcbiAgICAgIC4uLnRoaXMuX2RlZmF1bHRDb25maWc/Lndhcm5pbmcsXG4gICAgICAuLi5vcHRpb25zLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRvYXN0O1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqICBPcGVucyB1cCBhbiBob3QtdG9hc3Qgd2l0aCBwcmUtY29uZmlndXJhdGlvbnMgZm9yIGxvYWRpbmcgaW5pdGlhbGx5IGFuZCB0aGVuIGNoYW5nZXMgc3RhdGUgYmFzZWQgb24gbWVzc2FnZXNcbiAgICpcbiAgICogQHRlbXBsYXRlIFQgVHlwZSBvZiBvYnNlcnZhYmxlXG4gICAqIEBwYXJhbSBtZXNzYWdlcyBNZXNzYWdlcyBmb3IgZWFjaCBzdGF0ZSBpLmUuIGxvYWRpbmcsIHN1Y2Nlc3MgYW5kIGVycm9yXG4gICAqIEByZXR1cm5zXG4gICAqIEBtZW1iZXJvZiBIb3RUb2FzdFNlcnZpY2VcbiAgICovXG4gIG9ic2VydmU8VCwgRGF0YVR5cGU+KG1lc3NhZ2VzOiBPYnNlcnZhYmxlTWVzc2FnZXM8VCwgRGF0YVR5cGU+KTogKHNvdXJjZTogT2JzZXJ2YWJsZTxUPikgPT4gT2JzZXJ2YWJsZTxUPiB7XG4gICAgcmV0dXJuIChzb3VyY2UpID0+IHtcbiAgICAgIGxldCB0b2FzdFJlZjogQ3JlYXRlSG90VG9hc3RSZWY8RGF0YVR5cGUgfCB1bmtub3duPjtcbiAgICAgIGxldCBzdGFydCA9IDA7XG5cbiAgICAgIGNvbnN0IGxvYWRpbmdDb250ZW50ID0gbWVzc2FnZXMubG9hZGluZyA/PyB0aGlzLl9kZWZhdWx0Q29uZmlnLmxvYWRpbmc/LmNvbnRlbnQ7XG4gICAgICBjb25zdCBzdWNjZXNzQ29udGVudCA9IG1lc3NhZ2VzLnN1Y2Nlc3MgPz8gdGhpcy5fZGVmYXVsdENvbmZpZy5zdWNjZXNzPy5jb250ZW50O1xuICAgICAgY29uc3QgZXJyb3JDb250ZW50ID0gbWVzc2FnZXMuZXJyb3IgPz8gdGhpcy5fZGVmYXVsdENvbmZpZy5lcnJvcj8uY29udGVudDtcblxuICAgICAgcmV0dXJuIGRlZmVyKCgpID0+IHtcbiAgICAgICAgaWYgKGxvYWRpbmdDb250ZW50KSB7XG4gICAgICAgICAgdG9hc3RSZWYgPSB0aGlzLmNyZWF0ZUxvYWRpbmdUb2FzdDxULCBEYXRhVHlwZT4obG9hZGluZ0NvbnRlbnQpO1xuICAgICAgICAgIHN0YXJ0ID0gRGF0ZS5ub3coKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc291cmNlLnBpcGUoXG4gICAgICAgICAgdGFwKHtcbiAgICAgICAgICAgIC4uLihzdWNjZXNzQ29udGVudCAmJiB7XG4gICAgICAgICAgICAgIG5leHQ6ICh2YWwpID0+IHtcbiAgICAgICAgICAgICAgICB0b2FzdFJlZiA9IHRoaXMuY3JlYXRlT3JVcGRhdGVUb2FzdDxULCBEYXRhVHlwZSB8IHVua25vd24+KFxuICAgICAgICAgICAgICAgICAgbWVzc2FnZXMsXG4gICAgICAgICAgICAgICAgICB2YWwsXG4gICAgICAgICAgICAgICAgICB0b2FzdFJlZixcbiAgICAgICAgICAgICAgICAgICdzdWNjZXNzJyxcbiAgICAgICAgICAgICAgICAgIHN0YXJ0ID09PSAwID8gc3RhcnQgOiBEYXRlLm5vdygpIC0gc3RhcnRcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAuLi4oZXJyb3JDb250ZW50ICYmIHtcbiAgICAgICAgICAgICAgZXJyb3I6IChlKSA9PiB7XG4gICAgICAgICAgICAgICAgdG9hc3RSZWYgPSB0aGlzLmNyZWF0ZU9yVXBkYXRlVG9hc3Q8VCwgRGF0YVR5cGUgfCB1bmtub3duPihcbiAgICAgICAgICAgICAgICAgIG1lc3NhZ2VzLFxuICAgICAgICAgICAgICAgICAgZSxcbiAgICAgICAgICAgICAgICAgIHRvYXN0UmVmLFxuICAgICAgICAgICAgICAgICAgJ2Vycm9yJyxcbiAgICAgICAgICAgICAgICAgIHN0YXJ0ID09PSAwID8gc3RhcnQgOiBEYXRlLm5vdygpIC0gc3RhcnRcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICAgIH0pO1xuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQ2xvc2VzIHRoZSBob3QtdG9hc3RcbiAgICpcbiAgICogQHBhcmFtIFtpZF0gLSBJRCBvZiB0aGUgdG9hc3RcbiAgICogQHNpbmNlIDMuMC4xIC0gSWYgSUQgaXMgbm90IHByb3ZpZGVkLCBhbGwgdG9hc3RzIHdpbGwgYmUgY2xvc2VkXG4gICAqL1xuICBjbG9zZShpZD86IHN0cmluZykge1xuICAgIGlmICh0aGlzLl9jb21wb25lbnRSZWYpIHtcbiAgICAgIHRoaXMuX2NvbXBvbmVudFJlZi5yZWYuaW5zdGFuY2UuY2xvc2VUb2FzdChpZCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFVzZWQgZm9yIGludGVybmFsIHB1cnBvc2Ugb25seS5cbiAgICogQ3JlYXRlcyBhIGNvbnRhaW5lciBjb21wb25lbnQgYW5kIGF0dGFjaGVzIGl0IHRvIGRvY3VtZW50LmJvZHkuXG4gICAqL1xuICBwcml2YXRlIGluaXQoKSB7XG4gICAgaWYgKGlzUGxhdGZvcm1TZXJ2ZXIodGhpcy5wbGF0Zm9ybUlkKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLl9jb21wb25lbnRSZWYgPSB0aGlzLl92aWV3U2VydmljZVxuICAgICAgLmNyZWF0ZUNvbXBvbmVudChIb3RUb2FzdENvbnRhaW5lckNvbXBvbmVudClcbiAgICAgIC5zZXRJbnB1dCgnZGVmYXVsdENvbmZpZycsIHRoaXMuX2RlZmF1bHRDb25maWcpXG4gICAgICAuYXBwZW5kVG8oZG9jdW1lbnQuYm9keSk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZU9yVXBkYXRlVG9hc3Q8VCwgRGF0YVR5cGU+KFxuICAgIG1lc3NhZ2VzOiBPYnNlcnZhYmxlTWVzc2FnZXM8VCwgRGF0YVR5cGU+LFxuICAgIHZhbDogdW5rbm93bixcbiAgICB0b2FzdFJlZjogQ3JlYXRlSG90VG9hc3RSZWY8RGF0YVR5cGU+LFxuICAgIHR5cGU6IFRvYXN0VHlwZSxcbiAgICBkaWZmOiBudW1iZXJcbiAgKSB7XG4gICAgbGV0IGNvbnRlbnQ6IENvbnRlbnQgfCBWYWx1ZU9yRnVuY3Rpb248Q29udGVudCwgVD4gPSBudWxsO1xuICAgIGxldCBvcHRpb25zOiBUb2FzdE9wdGlvbnM8RGF0YVR5cGUgfCB1bmtub3duPiA9IHt9O1xuICAgICh7IGNvbnRlbnQsIG9wdGlvbnMgfSA9IHRoaXMuZ2V0Q29udGVudEFuZE9wdGlvbnM8YW55LCBEYXRhVHlwZT4oXG4gICAgICB0eXBlLFxuICAgICAgbWVzc2FnZXNbdHlwZV0gfHwgKHRoaXMuX2RlZmF1bHRDb25maWdbdHlwZV0gPyB0aGlzLl9kZWZhdWx0Q29uZmlnW3R5cGVdLmNvbnRlbnQgOiAnJylcbiAgICApKTtcbiAgICBjb250ZW50ID0gcmVzb2x2ZVZhbHVlT3JGdW5jdGlvbihjb250ZW50LCB2YWwpO1xuICAgIGlmICh0b2FzdFJlZikge1xuICAgICAgdG9hc3RSZWYudXBkYXRlTWVzc2FnZShjb250ZW50KTtcbiAgICAgIGNvbnN0IHVwZGF0ZWRPcHRpb25zOiBVcGRhdGVUb2FzdE9wdGlvbnM8RGF0YVR5cGU+ID0ge1xuICAgICAgICB0eXBlLFxuICAgICAgICBkdXJhdGlvbjogZGlmZiArIEhPVF9UT0FTVF9ERUZBVUxUX1RJTUVPVVRTW3R5cGVdLFxuICAgICAgICAuLi5vcHRpb25zLFxuICAgICAgICAuLi4ob3B0aW9ucy5kdXJhdGlvbiAmJiB7IGR1cmF0aW9uOiBkaWZmICsgb3B0aW9ucy5kdXJhdGlvbiB9KSxcbiAgICAgIH07XG4gICAgICB0b2FzdFJlZi51cGRhdGVUb2FzdCh1cGRhdGVkT3B0aW9ucyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY3JlYXRlVG9hc3Q8RGF0YVR5cGUsIFQ+KGNvbnRlbnQsIHR5cGUsIG9wdGlvbnMpO1xuICAgIH1cbiAgICByZXR1cm4gdG9hc3RSZWY7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVRvYXN0PERhdGFUeXBlLCBUID0gdW5rbm93bj4oXG4gICAgbWVzc2FnZTogQ29udGVudCxcbiAgICB0eXBlOiBUb2FzdFR5cGUsXG4gICAgb3B0aW9ucz86IERlZmF1bHRUb2FzdE9wdGlvbnMsXG4gICAgb2JzZXJ2YWJsZU1lc3NhZ2VzPzogT2JzZXJ2YWJsZU1lc3NhZ2VzPFQsIERhdGFUeXBlPlxuICApOiBDcmVhdGVIb3RUb2FzdFJlZjxEYXRhVHlwZSB8IHVua25vd24+IHtcbiAgICBpZiAoIXRoaXMuX2lzSW5pdGlhbGl6ZWQpIHtcbiAgICAgIHRoaXMuX2lzSW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgICAgdGhpcy5pbml0KCk7XG4gICAgfVxuXG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICBjb25zdCBpZCA9IG9wdGlvbnM/LmlkID8/IG5vdy50b1N0cmluZygpO1xuXG4gICAgaWYgKFxuICAgICAgIXRoaXMuaXNEdXBsaWNhdGUoaWQpICYmXG4gICAgICAoIW9wdGlvbnMucGVyc2lzdD8uZW5hYmxlZCB8fCAob3B0aW9ucy5wZXJzaXN0Py5lbmFibGVkICYmIHRoaXMuaGFuZGxlU3RvcmFnZVZhbHVlKGlkLCBvcHRpb25zKSkpXG4gICAgKSB7XG4gICAgICBjb25zdCB0b2FzdDogVG9hc3Q8RGF0YVR5cGUgfCB1bmtub3duPiA9IHtcbiAgICAgICAgYXJpYUxpdmU6IG9wdGlvbnM/LmFyaWFMaXZlID8/ICdwb2xpdGUnLFxuICAgICAgICBjcmVhdGVkQXQ6IG5vdyxcbiAgICAgICAgZHVyYXRpb246IG9wdGlvbnM/LmR1cmF0aW9uID8/IEhPVF9UT0FTVF9ERUZBVUxUX1RJTUVPVVRTW3R5cGVdLFxuICAgICAgICBpZCxcbiAgICAgICAgbWVzc2FnZSxcbiAgICAgICAgcm9sZTogb3B0aW9ucz8ucm9sZSA/PyAnc3RhdHVzJyxcbiAgICAgICAgdHlwZSxcbiAgICAgICAgdmlzaWJsZTogdHJ1ZSxcbiAgICAgICAgb2JzZXJ2YWJsZU1lc3NhZ2VzOiBvYnNlcnZhYmxlTWVzc2FnZXMgPz8gdW5kZWZpbmVkLFxuICAgICAgICAuLi5vcHRpb25zLFxuICAgICAgfTtcblxuICAgICAgcmV0dXJuIG5ldyBIb3RUb2FzdFJlZjxEYXRhVHlwZSB8IHVua25vd24+KHRvYXN0KS5hcHBlbmRUbyh0aGlzLl9jb21wb25lbnRSZWYucmVmLmluc3RhbmNlKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2tzIHdoZXRoZXIgYW55IHRvYXN0IHdpdGggc2FtZSBpZCBpcyBwcmVzZW50LlxuICAgKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAcGFyYW0gaWQgLSBUb2FzdCBJRFxuICAgKi9cbiAgcHJpdmF0ZSBpc0R1cGxpY2F0ZShpZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMuX2NvbXBvbmVudFJlZi5yZWYuaW5zdGFuY2UuaGFzVG9hc3QoaWQpO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgYW4gZW50cnkgaW4gbG9jYWwgb3Igc2Vzc2lvbiBzdG9yYWdlIHdpdGggY291bnQgJHtkZWZhdWx0Q29uZmlnLnBlcnNpc3QuY291bnR9LCBpZiBub3QgcHJlc2VudC5cbiAgICogSWYgcHJlc2VudCBpbiBzdG9yYWdlLCByZWR1Y2VzIHRoZSBjb3VudFxuICAgKiBhbmQgcmV0dXJucyB0aGUgY291bnQuXG4gICAqIENvdW50IGNhbiBub3QgYmUgbGVzcyB0aGFuIDAuXG4gICAqL1xuICBwcml2YXRlIGhhbmRsZVN0b3JhZ2VWYWx1ZShpZDogc3RyaW5nLCBvcHRpb25zOiBEZWZhdWx0VG9hc3RPcHRpb25zKTogbnVtYmVyIHtcbiAgICBsZXQgY291bnQgPSAxO1xuICAgIGNvbnN0IHBlcnNpc3QgPSB7IC4uLnRoaXMuX2RlZmF1bHRQZXJzaXN0Q29uZmlnLCAuLi5vcHRpb25zLnBlcnNpc3QgfTtcbiAgICBjb25zdCBzdG9yYWdlOiBTdG9yYWdlID0gcGVyc2lzdC5zdG9yYWdlID09PSAnbG9jYWwnID8gbG9jYWxTdG9yYWdlIDogc2Vzc2lvblN0b3JhZ2U7XG4gICAgY29uc3Qga2V5ID0gcGVyc2lzdC5rZXkucmVwbGFjZSgvXFwke2lkfS9nLCBpZCk7XG5cbiAgICBsZXQgaXRlbTogc3RyaW5nIHwgbnVtYmVyID0gc3RvcmFnZS5nZXRJdGVtKGtleSk7XG5cbiAgICBpZiAoaXRlbSkge1xuICAgICAgaXRlbSA9IHBhcnNlSW50KGl0ZW0sIDEwKTtcbiAgICAgIGlmIChpdGVtID4gMCkge1xuICAgICAgICBjb3VudCA9IGl0ZW0gLSAxO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY291bnQgPSBpdGVtO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBjb3VudCA9IHBlcnNpc3QuY291bnQ7XG4gICAgfVxuXG4gICAgc3RvcmFnZS5zZXRJdGVtKGtleSwgY291bnQudG9TdHJpbmcoKSk7XG5cbiAgICByZXR1cm4gY291bnQ7XG4gIH1cblxuICBwcml2YXRlIGdldENvbnRlbnRBbmRPcHRpb25zPFQsIERhdGFUeXBlPihcbiAgICB0b2FzdFR5cGU6IFRvYXN0VHlwZSxcbiAgICBtZXNzYWdlOiBDb250ZW50IHwgVmFsdWVPckZ1bmN0aW9uPENvbnRlbnQsIFQ+IHwgT2JzZXJ2YWJsZUxvYWRpbmc8RGF0YVR5cGU+IHwgT2JzZXJ2YWJsZVN1Y2Nlc3NPckVycm9yPFQsIERhdGFUeXBlPlxuICApOiB7IG9wdGlvbnM6IFRvYXN0T3B0aW9uczxEYXRhVHlwZSB8IHVua25vd24+OyBjb250ZW50OiBDb250ZW50IHwgVmFsdWVPckZ1bmN0aW9uPENvbnRlbnQsIFQ+IH0ge1xuICAgIGxldCBjb250ZW50OiBDb250ZW50IHwgVmFsdWVPckZ1bmN0aW9uPENvbnRlbnQsIFQ+O1xuICAgIGxldCBvcHRpb25zOiBUb2FzdE9wdGlvbnM8RGF0YVR5cGUgfCB1bmtub3duPiA9IHtcbiAgICAgIC4uLnRoaXMuX2RlZmF1bHRDb25maWcsXG4gICAgICAuLi50aGlzLl9kZWZhdWx0Q29uZmlnW3RvYXN0VHlwZV0sXG4gICAgfTtcblxuICAgIC8vIHR5cGVvZiBtZXNzYWdlID09PSAnb2JqZWN0JyB3b24ndCB3b3JrLCBjeiBUZW1wbGF0ZVJlZidzIHR5cGUgaXMgb2JqZWN0XG4gICAgaWYgKHR5cGVvZiBtZXNzYWdlID09PSAnc3RyaW5nJyB8fCBpc1RlbXBsYXRlUmVmKG1lc3NhZ2UpIHx8IGlzQ29tcG9uZW50KG1lc3NhZ2UpKSB7XG4gICAgICBjb250ZW50ID0gbWVzc2FnZTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IHJlc3RPcHRpb25zOiBUb2FzdE9wdGlvbnM8RGF0YVR5cGU+O1xuICAgICAgKHsgY29udGVudCwgLi4ucmVzdE9wdGlvbnMgfSA9IG1lc3NhZ2UgYXMgT2JzZXJ2YWJsZUxvYWRpbmc8RGF0YVR5cGU+IHwgT2JzZXJ2YWJsZVN1Y2Nlc3NPckVycm9yPFQsIERhdGFUeXBlPik7XG4gICAgICBvcHRpb25zID0geyAuLi5vcHRpb25zLCAuLi5yZXN0T3B0aW9ucyB9O1xuICAgIH1cblxuICAgIHJldHVybiB7IGNvbnRlbnQsIG9wdGlvbnMgfTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlTG9hZGluZ1RvYXN0PFQsIERhdGFUeXBlPihtZXNzYWdlczogQ29udGVudCB8IE9ic2VydmFibGVMb2FkaW5nPERhdGFUeXBlPikge1xuICAgIGxldCBjb250ZW50OiBDb250ZW50IHwgVmFsdWVPckZ1bmN0aW9uPENvbnRlbnQsIFQ+ID0gbnVsbDtcbiAgICBsZXQgb3B0aW9uczogVG9hc3RPcHRpb25zPERhdGFUeXBlIHwgdW5rbm93bj4gPSB7fTtcblxuICAgICh7IGNvbnRlbnQsIG9wdGlvbnMgfSA9IHRoaXMuZ2V0Q29udGVudEFuZE9wdGlvbnM8YW55LCBEYXRhVHlwZT4oJ2xvYWRpbmcnLCBtZXNzYWdlcykpO1xuXG4gICAgcmV0dXJuIHRoaXMubG9hZGluZyhjb250ZW50IGFzIENvbnRlbnQsIG9wdGlvbnMpO1xuICB9XG59XG4iXX0=